using System;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;

namespace mtkclient.library.xflash
{
    internal class MtkAuthExploitKamakiriService
    {
        public static async Task DoKamakiri2Async(
            IMtkUsbDevice device,
            byte[] lineCodeBuff,
            uint address,
            CancellationToken cancellationToken
        )
        {
            Console.WriteLine("Sending set linecode control transfer: 0x21 0x20");
            byte[] setLineCodeBuff = lineCodeBuff.Concat(BitConverter.GetBytes(address)).ToArray();
            await device.SendControlMessageAsync(33, 32, 0, 0, setLineCodeBuff, cancellationToken);
            Console.WriteLine("Control result: {0}", BitConverter.ToString(setLineCodeBuff));
            Console.WriteLine("Sending usb control transfer: 0x80 0x06");
            byte[] rbuff = new byte[9];
            await device.SendControlMessageAsync(128, 6, 512, 0, rbuff, cancellationToken);
            Console.WriteLine("Control result: {0}", BitConverter.ToString(rbuff));
        }
    }
}
